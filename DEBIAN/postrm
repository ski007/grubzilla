#!/bin/bash
set -e

# Dodajemy PATH, Å¼eby skrypt zawsze widziaÅ‚ narzÄ™dzia systemowe
export PATH=$PATH:/usr/local/sbin:/usr/sbin:/sbin

GRUB_FILE="/etc/grub.d/40_custom"

case "$1" in
    remove|purge)
        echo "ðŸ§¹ Usuwanie wpisÃ³w GrubZilla (CloneZilla) z 40_custom..."

        if [[ -f "$GRUB_FILE" ]]; then
            # Usuwanie blokÃ³w menuentry
            sed -i '/^menuentry "CloneZilla - Automatyczny Backup Systemu.*(na USB)"/,/^}/d' "$GRUB_FILE"
            sed -i '/^menuentry "CloneZilla - Automatyczne Przywracanie Systemu.*(ostatni zapisany obraz na USB)"/,/^}/d' "$GRUB_FILE"
            sed -i '/^menuentry "CloneZilla - Standard TUI (PL).*"/,/^}/d' "$GRUB_FILE"
            
            # Usuwanie zbÄ™dnych pustych linii
            sed -i '/^$/d' "$GRUB_FILE"
        fi

        echo "ðŸ”„ Aktualizacja konfiguracji GRUB..."
        # Bezpieczne wywoÅ‚anie aktualizacji GRUB
        if command -v update-grub > /dev/null 2>&1; then
            update-grub || echo "OstrzeÅ¼enie: Nie udaÅ‚o siÄ™ zaktualizowaÄ‡ GRUB."
        else
            grub-mkconfig -o /boot/grub/grub.cfg || echo "OstrzeÅ¼enie: Nie udaÅ‚o siÄ™ zaktualizowaÄ‡ GRUB."
        fi

        # OdÅ›wieÅ¼enie bazy plikÃ³w .desktop (bez peÅ‚nej Å›cieÅ¼ki, by uciszyÄ‡ Lintiana)
        if command -v update-desktop-database > /dev/null 2>&1; then
            update-desktop-database -q /usr/share/applications || true
        fi
        ;;

    upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

exit 0
