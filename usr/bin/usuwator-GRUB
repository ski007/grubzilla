#!/bin/bash
# =================================================================
# usuwator_GRUB.sh
# - usuwa wszystkie wpisy w pliku 40_custom o nazwie: CloneZilla
# - tworzy kopiÄ™ zapasowÄ… pliku : 40_custom w folderze domowym uÅ¼ytkownika
# =================================================================
# --- Konfiguracja ---
GRUB_FILE="/etc/grub.d/40_custom"
KEYWORD="CloneZilla"
TEMP_FILE=$(mktemp) # Utworzenie bezpiecznego pliku tymczasowego

# --- Sprawdzenie uprawnieÅ„ ---
if [ "$(id -u)" -ne 0 ]; then
  echo "ğŸš« Ten skrypt musi byÄ‡ uruchomiony z uprawnieniami administratora (sudo)." >&2
  exit 1
fi

# --- Sprawdzenie, czy plik istnieje ---
if [ ! -f "$GRUB_FILE" ]; then
  echo "âš ï¸ Plik $GRUB_FILE nie istnieje. Prerywam dziaÅ‚anie."
  exit 1
fi

# --- Sprawdzenie, czy sÄ… wpisy do usuniÄ™cia ---
if ! grep -q "menuentry.*${KEYWORD}" "$GRUB_FILE"; then
    echo "ğŸ‘ Nie znaleziono Å¼adnych wpisÃ³w '${KEYWORD}'. Plik nie wymaga zmian."
    exit 0
fi

# --- Tworzenie kopii zapasowej (tylko jeÅ›li sÄ… zmiany do zrobienia) ---
if [ -n "$SUDO_USER" ]; then
  USER_HOME=$(getent passwd "$SUDO_USER" | cut -d: -f6)
else
  USER_HOME="/root"
fi
BACKUP_FILENAME="40_custom_backup_$(date +%Y-%m-%d_%H-%M-%S)"
BACKUP_PATH="$USER_HOME/$BACKUP_FILENAME"

echo "ğŸ›¡ï¸  Znaleziono wpisy. TworzÄ™ kopiÄ™ zapasowÄ… pliku $GRUB_FILE..."
cp "$GRUB_FILE" "$BACKUP_PATH"
if [ -n "$SUDO_USER" ]; then
  chown "$SUDO_USER:$SUDO_USER" "$BACKUP_PATH"
fi
echo "âœ… Kopia zapasowa zapisana w: $BACKUP_PATH"
echo "-----------------------------------------------------"


# --- WÅ‚aÅ›ciwe czyszczenie pliku za pomocÄ… AWK ---
echo "ğŸ”¥ Usuwam wszystkie wpisy '${KEYWORD}' za pomocÄ… awk..."

awk -v keyword="$KEYWORD" '
  # JeÅ›li linia zawiera "menuentry" i nasze sÅ‚owo kluczowe, ustaw flagÄ™ i przejdÅº do nastÄ™pnej linii
  $0 ~ "menuentry.*" keyword {
    in_block=1;
    next;
  }
  # JeÅ›li jesteÅ›my w bloku i linia zaczyna siÄ™ od "}", zdejmij flagÄ™ i przejdÅº do nastÄ™pnej linii
  in_block && /^}/ {
    in_block=0;
    next;
  }
  # JeÅ›li nie jesteÅ›my w bloku do usuniÄ™cia, wydrukuj liniÄ™
  !in_block {
    print;
  }
' "$GRUB_FILE" > "$TEMP_FILE"

# ZastÄ…pienie starego pliku nowym, wyczyszczonym
mv "$TEMP_FILE" "$GRUB_FILE"
# Ustawienie prawidÅ‚owych uprawnieÅ„ (mv moÅ¼e je czasem zmieniÄ‡)
chmod 755 "$GRUB_FILE"

echo "âœ… Czyszczenie zakoÅ„czone."

# --- Aktualizacja GRUB ---
echo "ğŸ”„ AktualizujÄ™ konfiguracjÄ™ GRUB..."
update-grub

echo "ğŸ‰ Gotowe! GRUB zaktualizowany."
echo ""
read -p "ğŸ‘‰ ENTER, aby zamknÄ…Ä‡..." 
